SELECT 
UWI,
WELL_NAME,
PROD_DATE,
MEASUREMENT_DAY,
MEASUREMENT_DATE_15,
TPO0,
YPO0,
TPO5,
YPO5,
TPW0,
YPW0,
PTTOT,
PYTOT
FROM (SELECT
UWI,
WELL_NAME,
PROD_DATE,
MEASUREMENT_DAY,
MEASUREMENT_DATE_15,
MAX(CASE WHEN MEASUREMENT_TYPE='TPO0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPO0,
MAX(CASE WHEN MEASUREMENT_TYPE='YPO0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPO0,
MAX(CASE WHEN MEASUREMENT_TYPE='TPO5' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPO5,
MAX(CASE WHEN MEASUREMENT_TYPE='YPO5' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPO5,
MAX(CASE WHEN MEASUREMENT_TYPE='TPW0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPW0,
MAX(CASE WHEN MEASUREMENT_TYPE='YPW0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPW0,
MAX(CASE WHEN MEASUREMENT_TYPE='PTTOT' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) PTTOT,
MAX(CASE WHEN MEASUREMENT_TYPE='PYTOT' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) PYTOT
FROM
(SELECT 
WE.UWI,
W.WELL_NAME, 
W.CENTRAL_FACILITY_NAME,
CAST((MDT1.MEASUREMENT_DATE - INTERVAL '421' MINUTE) AS DATE) AS PROD_DATE,
MDT1.MEASUREMENT_DAY,
CAST( CAST(MEASUREMENT_DAY AS CHAR(10)) ||' '|| 
            CAST(CAST(EXTRACT (HOUR FROM MEASUREMENT_DATE) AS BYTEINT FORMAT '99') AS CHAR(2))||':'|| 
            CAST(CAST((FLOOR (EXTRACT (MINUTE FROM MEASUREMENT_DATE))/15 )*15 AS BYTEINT FORMAT '99')AS CHAR(2))|| ':00'
            AS TIMESTAMP(0)) AS MEASUREMENT_DATE_15,
MDT1.MEASUREMENT_TYPE, 
MDT1.MEASUREMENT_NUMBER_VALUE
FROM IDW_CORE_V.MEASUREMENT_DETAIL MDT1,
      IDW_BI_PUBLIC.WELL_EQUIPMENT WE,
      IDW_BI_PUBLIC.WELL W
WHERE 
      MDT1.EQUIPMENT_ID = WE.EQUIPMENT_ID
	  AND WE.UWI = W.UWI
      AND (WE.EQUIPMENT_TYPE = 'SCR' AND MEASUREMENT_TYPE IN ('TPO0', 'TPO5', 'TPW0','YPO0', 'YPO5', 'YPW0','PTTOT','PYTOT'))
      AND MEASUREMENT_DAY BETWEEN CURRENT_DATE - 1 AND CURRENT_DATE
      ) A
      WHERE PROD_DATE=CURRENT_DATE
	  GROUP BY 1,2,3,4,5)B
      QUALIFY RANK() OVER (PARTITION BY UWI ORDER BY MEASUREMENT_DATE_15 DESC)=1
      UNION
      SELECT
FACILITY_ID,
'' AS WELL_NAME,
PROD_DATE,
MEASUREMENT_DAY,
MEASUREMENT_DATE_15,
NULL,
NULL,
TPL0,
YPL0,
TPW0,
YPW0,
TPG0,
YPG0
FROM
(SELECT
FACILITY_ID,
PROD_DATE,
MEASUREMENT_DAY,
MEASUREMENT_DATE_15,
MAX(CASE WHEN MEASUREMENT_TYPE='YPG0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPG0,
MAX(CASE WHEN MEASUREMENT_TYPE='TPG0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPG0,
MAX(CASE WHEN MEASUREMENT_TYPE='TPW0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPW0,
MAX(CASE WHEN MEASUREMENT_TYPE='YPW0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPW0,
MAX(CASE WHEN MEASUREMENT_TYPE='YPL0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) YPL0,
MAX(CASE WHEN MEASUREMENT_TYPE='TPL0' THEN MEASUREMENT_NUMBER_VALUE ELSE NULL END) TPL0
FROM
(SELECT 
WE1.EQUIPMENT_ID,
WE1.FACILITY_ID,
WE1.FACILITY_TYPE,
CAST((MDT.MEASUREMENT_DATE - INTERVAL '421' MINUTE) AS DATE) AS PROD_DATE,
MDT.MEASUREMENT_DAY,
CAST( CAST(MEASUREMENT_DAY AS CHAR(10)) ||' '|| 
CAST( CAST(EXTRACT (HOUR FROM MEASUREMENT_DATE) AS BYTEINT FORMAT '99') AS CHAR(2))||':'|| 
CAST(CAST((FLOOR (EXTRACT (MINUTE FROM MEASUREMENT_DATE))/15 )*15 AS BYTEINT FORMAT '99')AS CHAR(2))|| ':00'
AS TIMESTAMP(0)) AS MEASUREMENT_DATE_15,
MDT.MEASUREMENT_TYPE,
MDT.MEASUREMENT_NUMBER_VALUE
FROM IDW_CORE_V.MEASUREMENT_DETAIL MDT,
     IDW_CORE_V.FACILITY_EQUIPMENT WE1
WHERE 
     MDT.EQUIPMENT_ID = WE1.EQUIPMENT_ID
	 AND MEASUREMENT_TYPE IN ('TPG0', 'TPW0','YPL0','YPG0','TPL0','YPW0')
	 AND MEASUREMENT_DAY BETWEEN CURRENT_DATE-1 AND CURRENT_DATE
	 AND WE1.EQUIPMENT_ID LIKE '%SCR%' AND WE1.EXPIRY_DATE > DATE AND WE1.FACILITY_TYPE='CF') A
WHERE PROD_DATE = DATE
GROUP BY 1,2,3,4)B
QUALIFY RANK() OVER (PARTITION BY FACILITY_ID ORDER BY MEASUREMENT_DATE_15 DESC)=1;
